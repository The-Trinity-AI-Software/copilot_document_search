<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lease Document Search Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f0f4f8; font-family: 'Segoe UI', sans-serif; }
.card { margin-bottom: 20px; }
.section-header { background-color: #1e3a8a; color: white; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px; }
#comment { font-weight: bold; color: red; margin-top: 20px; }
</style>
</head>
<body class="container py-4">

<h2 class="text-center mb-4">üìë Lease Document AI Dashboard</h2>

<!-- Upload -->
<div class="card">
  <div class="section-header">üìÇ Upload Lease Folder</div>
  <div class="card-body">
    <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
      <input type="file" name="files[]" multiple directory webkitdirectory mozdirectory class="form-control mb-3" required>
      <button type="submit" class="btn btn-primary">Upload Folder</button>
    </form>
    <div id="uploadResult" class="mt-3"></div> <!-- Upload result here -->
  </div>
</div>

<!-- Search -->
<div class="card">
  <div class="section-header">üîç Search Lease</div>
  <div class="card-body">
    <form id="searchForm">
      <label>Search Mode:</label>
      <select id="searchMode" class="form-select mb-3" required>
        <option value="lease">Lease Smart Search</option>
        <option value="document">Document AI Search</option>
      </select>
      <input type="text" name="query" class="form-control mb-3" placeholder="Enter your query..." required>
      <button type="submit" class="btn btn-success">Search</button>
      <button type="button" class="btn btn-secondary" onclick="resetResults()">Reset</button>
    </form>

    <div id="comment"></div>
    <div id="results" class="mt-4"></div>

    <div class="mt-4">
      <button class="btn btn-info" onclick="downloadFile('excel')">Download as Excel</button>
      <button class="btn btn-warning" onclick="downloadFile('json')">Download as JSON</button>
    </div>
  </div>
</div>

<script>
let latestResults = [];

// Upload handler
document.getElementById("uploadForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);

    fetch("/upload", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById("uploadResult").innerHTML = `<div class="alert alert-success">${data.message}</div>`;
    })
    .catch(error => {
        document.getElementById("uploadResult").innerHTML = `<div class="alert alert-danger">Upload failed. Please try again.</div>`;
    });
});

// Search handler
document.getElementById("searchForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    formData.append("search_mode", document.getElementById("searchMode").value);

    fetch("/search", { method: "POST", body: formData })
    .then(response => response.json())
    .then(data => {
        latestResults = data.results || data;
        const resultDiv = document.getElementById("results");
        const commentDiv = document.getElementById("comment");

        // Comment
        if (data.comment) {
            commentDiv.innerText = data.comment;
        } else {
            commentDiv.innerText = "";
        }

        if (!latestResults.length) {
            resultDiv.innerHTML = "<p>No results found.</p>";
            return;
        }

        // Table
        let keys = Object.keys(latestResults[0]);
        let table = '<table class="table table-bordered"><thead><tr>';
        keys.forEach(key => table += `<th>${key}</th>`);
        table += '</tr></thead><tbody>';

        latestResults.forEach(row => {
            table += '<tr>';
            keys.forEach(key => table += `<td>${row[key]}</td>`);
            table += '</tr>';
        });

        table += '</tbody></table>';
        resultDiv.innerHTML = table;
    });
});

function downloadFile(filetype) {
    if (!latestResults.length) {
        alert("Please run search first");
        return;
    }

    fetch(`/download_${filetype}`, {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(latestResults)
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        const timestamp = new Date().toISOString().replace(/[-:T.]/g, "").slice(0, 14);
        a.download = `${filetype}_export_${timestamp}.${filetype === 'excel' ? 'xlsx' : 'json'}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    });
}

function resetResults() {
    document.getElementById("results").innerHTML = "";
    document.getElementById("comment").innerText = "";
    document.getElementById("searchForm").reset();
}
</script>

</body>
</html>
